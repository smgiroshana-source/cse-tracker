<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="CSE Tracker">
<meta name="theme-color" content="#ffffff">
<title>CSE Disclosure Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body {
  min-height:100vh; background:#f1f5f9;
  color:#1e293b; font-family:'DM Sans','Segoe UI',system-ui,sans-serif;
  -webkit-font-smoothing:antialiased;
}

.header {
  background:#fff; border-bottom:1px solid #e2e8f0;
  padding:16px 16px 12px; position:sticky; top:0; z-index:50;
}
.header-row { display:flex; align-items:center; justify-content:space-between; }
.logo { font-size:20px; font-weight:700; color:#1e40af; }
.sub { font-size:11px; color:#94a3b8; margin-top:1px; }
.btn-refresh {
  background:#2563eb; border:none; border-radius:10px; padding:8px 16px;
  color:#fff; font-size:13px; font-weight:600; cursor:pointer;
}
.btn-refresh:active { transform:scale(.95); }

#search-box {
  width:100%; background:#f8fafc; border:1px solid #e2e8f0;
  border-radius:10px; padding:10px 14px 10px 36px;
  color:#1e293b; font-size:14px; outline:none; font-family:'DM Sans';
  margin-top:10px;
}
#search-box:focus { border-color:#2563eb; background:#fff; }
#search-box::placeholder { color:#94a3b8; }
.search-wrap { position:relative; }
.search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:14px; color:#94a3b8; margin-top:5px; }

.filters { display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
.chip {
  border-radius:20px; padding:6px 12px; font-size:12px; cursor:pointer;
  font-family:'DM Sans'; border:1px solid #e2e8f0; background:#fff;
  color:#64748b; font-weight:500; transition:all .15s;
}
.chip.active { background:#2563eb; color:#fff; border-color:#2563eb; font-weight:600; }

.cards { padding:8px 12px 100px; }
.card {
  background:#fff; border:1px solid #e2e8f0;
  border-radius:14px; padding:14px 16px; margin-bottom:8px;
  cursor:pointer; transition:all .15s; box-shadow:0 1px 3px rgba(0,0,0,.04);
}
.card.expanded { border-color:#2563eb; box-shadow:0 2px 12px rgba(37,99,235,.1); }

.card-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.badge {
  padding:3px 8px; border-radius:6px; font-size:10px; font-weight:600;
  letter-spacing:.3px; white-space:nowrap;
}
.card-date { font-size:11px; color:#94a3b8; }
.card-company { font-size:15px; font-weight:700; color:#0f172a; margin-bottom:4px; }
.card-summary { font-size:13px; color:#64748b; line-height:1.5; overflow:hidden; transition:max-height .3s; }
.card-summary.clamped { max-height:40px; }
.card-detail { margin-top:10px; padding-top:10px; border-top:1px solid #f1f5f9; }
.card-desc { font-size:12px; color:#94a3b8; margin-bottom:8px; }
.card-meta { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.card-time { font-size:11px; color:#94a3b8; }
.btn-pdf {
  background:#2563eb; color:#fff; padding:8px 16px; border-radius:10px;
  font-size:13px; font-weight:600; text-decoration:none;
  display:inline-flex; align-items:center; gap:4px;
}
.btn-pdf:active { transform:scale(.95); }

.empty { text-align:center; padding:40px; color:#94a3b8; }
.empty-icon { font-size:40px; margin-bottom:12px; }
.error { margin:12px; padding:14px; background:#fef2f2; border-radius:10px; border:1px solid #fecaca; font-size:13px; color:#991b1b; }
.error-hint { margin-top:6px; font-size:11px; color:#b91c1c; }
.loading { text-align:center; padding:60px 20px; color:#94a3b8; }
@keyframes spin { to{transform:rotate(360deg)} }
.spinner { font-size:28px; display:inline-block; animation:spin 1s linear infinite; }

.count { padding:10px 16px 4px; font-size:12px; color:#94a3b8; }

.bottom-bar {
  position:fixed; bottom:0; left:0; right:0;
  background:linear-gradient(180deg,transparent,#f1f5f9 30%);
  padding:16px 12px 12px;
}
.bottom-inner {
  display:flex; justify-content:space-around;
  background:#fff; border-radius:14px;
  border:1px solid #e2e8f0; padding:8px;
  box-shadow:0 -2px 10px rgba(0,0,0,.05);
}
.bottom-btn {
  background:transparent; border:none; border-radius:10px;
  padding:8px 14px; color:#94a3b8; font-size:11px; cursor:pointer;
  text-align:center; font-family:'DM Sans'; font-weight:600; transition:all .15s;
}
.bottom-btn.active { color:#2563eb; background:#eff6ff; }
.bottom-emoji { font-size:18px; }
.bottom-count { font-size:13px; font-weight:700; color:#1e293b; }
.bottom-label { font-size:9px; margin-top:1px; }
</style>
</head>
<body>

<div class="header">
  <div class="header-row">
    <div>
      <div class="logo">üìä CSE Tracker</div>
      <div class="sub" id="subtitle">Loading...</div>
    </div>
    <button class="btn-refresh" onclick="fetchData()">Refresh</button>
  </div>
  <div class="search-wrap">
    <span class="search-icon">üîç</span>
    <input id="search-box" type="text" placeholder="Search company or keyword...">
  </div>
  <div class="filters" id="filters"></div>
</div>

<div id="content"></div>
<div id="bottom"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRFnm5weSmdc4AkDCmN7HL1M5DGymv5N1MiJfSG3BFneRi-Cqj3dmfYWZINQGQjJ3ONFaBpCDk1NyEn/pub?output=csv";

const GROUPS = {
  "Dividends":     { emoji:"üí∞", match: s => s.includes("CASH DIVIDEND") },
  "Dealings":      { emoji:"üîÑ", match: s => s.includes("DEALINGS BY DIRECTORS") },
  "Rights Issue":  { emoji:"üìà", match: s => s.includes("RIGHTS ISSUE") },
  "Restructuring": { emoji:"üë•", match: s => ["APPOINTMENT","RESIGNATION","RETIREMENT","REMOVAL","DEATH"].some(k => s.includes(k)) },
  "Other":         { emoji:"üìã", match: s => true },
};

function getGroup(subject) {
  const s = (subject||"").toUpperCase();
  for (const [name, cfg] of Object.entries(GROUPS)) {
    if (name !== "Other" && cfg.match(s)) return name;
  }
  return "Other";
}

const BADGE = {
  "CASH DIVIDEND":["#059669","#ecfdf5"], "CORPORATE DISCLOSURE":["#2563eb","#eff6ff"],
  "DEALINGS BY DIRECTORS":["#d97706","#fffbeb"], "APPOINTMENT OF DIRECTORS":["#7c3aed","#f5f3ff"],
  "RESIGNATION OF DIRECTORS":["#dc2626","#fef2f2"], "RESIGNATION OF CHAIRPERSON":["#dc2626","#fef2f2"],
  "RETIREMENT OF THE CHAIRPERSON":["#dc2626","#fef2f2"], "APPOINTMENT OF CHAIRPERSON":["#7c3aed","#f5f3ff"],
  "RIGHTS ISSUE":["#2563eb","#eff6ff"], "TRADING HALTED":["#dc2626","#fef2f2"],
  "TRADING HALT LIFTED":["#059669","#ecfdf5"], "EXTRAORDINARY GENERAL":["#7c3aed","#f5f3ff"],
  "DEBENTURE":["#0891b2","#ecfeff"], "RATING REVIEW":["#ca8a04","#fefce8"],
  "WATCH LIST":["#ea580c","#fff7ed"], "CIRCULAR":["#0891b2","#ecfeff"],
  "CLARIFICATION":["#d97706","#fffbeb"], "ERRATA":["#ec4899","#fdf2f8"],
};
function getBadge(s) {
  for (const [k,v] of Object.entries(BADGE)) { if (s.includes(k)) return v; }
  return ["#64748b","#f8fafc"];
}

function parseCSV(text) {
  const lines=[]; let row=[],cell="",inQ=false;
  for (let i=0;i<text.length;i++) {
    const c=text[i];
    if (c==='"'){if(inQ&&text[i+1]==='"'){cell+='"';i++}else inQ=!inQ}
    else if(c===','&&!inQ){row.push(cell);cell=""}
    else if((c==='\n'||c==='\r')&&!inQ){if(cell||row.length){row.push(cell);lines.push(row);row=[];cell=""}if(c==='\r'&&text[i+1]==='\n')i++}
    else cell+=c;
  }
  if(cell||row.length){row.push(cell);lines.push(row)}
  return lines;
}

function extractPdf(link) {
  if(!link) return null;
  const m=link.match(/HYPERLINK\("([^"]+)"/);
  if(m) return m[1];
  if(link.startsWith("http")) return link;
  return null;
}

let data=[],filtered=[],search="",selectedGroup="ALL",expanded=null;
let loading=true,error=null,lastUpdate=null;

document.getElementById("search-box").addEventListener("input", function() {
  search=this.value; applyFilter();
});

async function fetchData() {
  try {
    loading=true; error=null; renderContent();
    const resp=await fetch(CSV_URL);
    if(!resp.ok) throw new Error("Failed to fetch");
    const text=await resp.text();
    const lines=parseCSV(text);
    if(lines.length<2) throw new Error("No data");
    data=lines.slice(1).filter(r=>r[2]).map((r,i)=>({
      id:i, date:r[0]||"", time:r[1]||"", company:r[2]||"",
      subject:r[3]||"", description:r[4]||"", summary:r[5]||"",
      pdfLink:r[6]||"", pdfCount:r[7]||"0", group:getGroup(r[3]||""),
    }));
    lastUpdate=new Date(); error=null;
  } catch(e){error=e.message}
  finally{loading=false; applyFilter()}
}

function applyFilter() {
  filtered=data.filter(item=>{
    if(selectedGroup!=="ALL"&&item.group!==selectedGroup) return false;
    if(search){
      const q=search.toLowerCase();
      return item.company.toLowerCase().includes(q)||item.summary.toLowerCase().includes(q)||item.description.toLowerCase().includes(q);
    }
    return true;
  });
  renderFilters(); renderContent(); renderBottom();
  document.getElementById("subtitle").textContent=
    `${data.length} disclosures${lastUpdate?" ¬∑ "+lastUpdate.toLocaleTimeString():""}`;
}

function getGroupCounts() {
  const c={}; data.forEach(d=>{c[d.group]=(c[d.group]||0)+1}); return c;
}

function renderFilters() {
  const counts=getGroupCounts();
  document.getElementById("filters").innerHTML=
    ["ALL","Dividends","Dealings","Rights Issue","Restructuring","Other"].map(g=>{
      const active=selectedGroup===g;
      const cnt=g==="ALL"?data.length:counts[g]||0;
      const emoji=GROUPS[g]?GROUPS[g].emoji+" ":"";
      const label=g==="ALL"?`All (${cnt})`:`${emoji}${g} (${cnt})`;
      return `<button class="chip${active?" active":""}" onclick="selectedGroup='${g}';applyFilter()">${label}</button>`;
    }).join("");
}

function renderContent() {
  const el=document.getElementById("content");
  if(error){el.innerHTML=`<div class="error">‚ö†Ô∏è ${error}<div class="error-hint">Publish your Google Sheet: File ‚Üí Share ‚Üí Publish to web ‚Üí CSV</div></div>`;return}
  if(loading&&!data.length){el.innerHTML=`<div class="loading"><div class="spinner">‚ü≥</div><br>Loading...</div>`;return}

  let html=`<div class="count">${filtered.length} result${filtered.length!==1?"s":""}${search?' for "'+search+'"':""}${selectedGroup!=="ALL"?" in "+selectedGroup:""}</div><div class="cards">`;

  filtered.forEach(item=>{
    const isExp=expanded===item.id;
    const pdfUrl=extractPdf(item.pdfLink);
    const [bc,bbg]=getBadge(item.subject);
    const short=item.subject.length>28?item.subject.slice(0,25)+"...":item.subject;
    const sum=item.summary||item.description||"‚Äî";

    html+=`<div class="card${isExp?" expanded":""}" onclick="expanded=${isExp?"null":item.id};renderContent()">`;
    html+=`<div class="card-top"><span class="badge" style="background:${bbg};color:${bc}">${short}</span><span class="card-date">${item.date}</span></div>`;
    html+=`<div class="card-company">${item.company}</div>`;
    html+=`<div class="card-summary${isExp?"":" clamped"}">${sum}</div>`;
    if(isExp){
      html+=`<div class="card-detail">`;
      if(item.description&&item.description!==item.summary) html+=`<div class="card-desc">${item.description}</div>`;
      html+=`<div class="card-meta">`;
      if(item.time) html+=`<span class="card-time">üïê ${item.time}</span>`;
      if(pdfUrl) html+=`<a class="btn-pdf" href="${pdfUrl}" target="_self" onclick="event.stopPropagation()">üìÑ Open PDF</a>`;
      html+=`</div></div>`;
    }
    html+=`</div>`;
  });

  if(!filtered.length) html+=`<div class="empty"><div class="empty-icon">üîç</div>No disclosures found</div>`;
  html+=`</div>`;
  el.innerHTML=html;
}

function renderBottom() {
  const counts=getGroupCounts();
  const btns=[
    {label:"Dividends",key:"Dividends",emoji:"üí∞"},
    {label:"Rights",key:"Rights Issue",emoji:"üìà"},
    {label:"Dealings",key:"Dealings",emoji:"üîÑ"},
  ];
  let html=`<div class="bottom-bar"><div class="bottom-inner">`;
  btns.forEach(f=>{
    const active=selectedGroup===f.key;
    html+=`<button class="bottom-btn${active?" active":""}" onclick="selectedGroup=selectedGroup==='${f.key}'?'ALL':'${f.key}';applyFilter()">
      <div class="bottom-emoji">${f.emoji}</div>
      <div class="bottom-count">${counts[f.key]||0}</div>
      <div class="bottom-label">${f.label}</div>
    </button>`;
  });
  html+=`</div></div>`;
  document.getElementById("bottom").innerHTML=html;
}

fetchData();
setInterval(fetchData,300000);
</script>
</body>
</html>
